name: Publish

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
    inputs:
      tag:
        description: "Version tag to publish (e.g. v0.2.0)"
        required: true
  release:
    types:
      - published

jobs:
  checks:
    name: quality-checks
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')) ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Restore | Checkout repository
        uses: actions/checkout@v4

      - name: Restore | Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Restore | Validate input tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ ! "${{ inputs.tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Tag must be semantic version prefixed with v (e.g. v1.2.3)" >&2
            exit 1
          fi

      - name: Restore | Checkout requested ref
        if: github.event_name == 'workflow_dispatch'
        run: |
          git fetch --tags --force
          git checkout ${{ inputs.tag }}

      - name: Restore | Checkout release tag
        if: github.event_name == 'release'
        run: |
          git fetch --tags --force
          git checkout ${{ github.event.release.tag_name }}

      - name: Restore | Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.dartServer
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Restore | Fetch dependencies
        run: flutter pub get

      - name: Build | Prepare coverage directories
        run: mkdir -p coverage/dart coverage/flutter reports

      - name: Build | Generate code
        run: dart run build_runner build -d

      - name: Test | Format check
        run: dart format --output=none --set-exit-if-changed lib test test_vm example

      - name: Test | Flutter analyze
        run: |
          set -o pipefail
          flutter analyze | tee reports/flutter_analyze.txt

      - name: Test | Dart analyze
        run: |
          set -o pipefail
          dart analyze | tee reports/dart_analyze.txt

      - name: Test | Dart unit tests with coverage
        run: |
          set -o pipefail
          dart test --coverage=coverage/dart --reporter expanded | tee reports/dart_tests.txt

      - name: Test | Convert dart coverage
        run: |
          dart run coverage:format_coverage \
            --packages=.dart_tool/package_config.json \
            --report-on=lib \
            --in=coverage/dart/test \
            --out=coverage/dart/lcov.info \
            --lcov

      - name: Test | Flutter widget tests with coverage
        run: |
          set -o pipefail
          flutter test --reporter expanded --coverage --coverage-path coverage/flutter/lcov.info test/runtime_test.dart | tee reports/flutter_tests.txt

      - name: Test | Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-coverage
          path: coverage

      - name: Test | Upload analysis and test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-reports
          path: reports

      - name: Test | Pana score
        run: dart run pana --no-warning

      - name: Publish | Dry run
        run: flutter pub publish --dry-run

  publish:
    name: publish
    needs: checks
    if: >
      (github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')) ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))) &&
      needs.checks.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment:
      name: pub-dev
      url: https://pub.dev/packages/semantic_gen
    steps:
      - name: Restore | Checkout repository
        uses: actions/checkout@v4

      - name: Restore | Install Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: Restore | Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Restore | Validate input tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ ! "${{ inputs.tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Tag must be semantic version prefixed with v (e.g. v1.2.3)" >&2
            exit 1
          fi

      - name: Restore | Checkout requested ref
        if: github.event_name == 'workflow_dispatch'
        run: |
          git fetch --tags --force
          git checkout ${{ inputs.tag }}

      - name: Restore | Checkout release tag
        if: github.event_name == 'release'
        run: |
          git fetch --tags --force
          git checkout ${{ github.event.release.tag_name }}

      - name: Restore | Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.dartServer
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Restore | Fetch dependencies
        run: dart pub get

      - name: Version | Get version from event
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION_FROM_EVENT="${{ inputs.tag }}"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION_FROM_EVENT="${{ github.event.release.tag_name }}"
          else
            VERSION_FROM_EVENT="${GITHUB_REF_NAME}"
          fi
          echo "TAG_VERSION=${VERSION_FROM_EVENT#v}" >> $GITHUB_OUTPUT

      - name: Version | Update pubspec.yaml
        run: |
          VERSION=${{ steps.get_version.outputs.TAG_VERSION }}
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml

      - name: Version | Commit and push pubspec.yaml
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore(release): version ${{ steps.get_version.outputs.TAG_VERSION }}"
          git push

      - name: Publish | Dry run
        run: dart pub publish --dry-run

      - name: Publish | Publish to pub.dev
        env:
          PUB_ALLOW_PRERELEASE_SDK: "true"
        run: dart pub publish --force
